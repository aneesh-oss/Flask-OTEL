[SERVICE]
    Flush         1
    Log_Level     info
    Parsers_File  /fluent-bit/etc/parsers.conf

# Tail all Docker container logs
[INPUT]
    Name   tail
    Path   /var/lib/docker/containers/*/*.log
    Parser docker
    Tag    kube.*

# Match logs from cuse-service container
[FILTER]
    Name   grep
    Match  kube.*
    Regex  container_name  cuser-service

[FILTER]
    Name   record_modifier
    Match  kube.*
    Record service.name user-api

# Match logs from corder-service container
[FILTER]
    Name   grep
    Match  kube.*
    Regex  container_name  corder-service

[FILTER]
    Name   record_modifier
    Match  kube.*
    Record service.name order-api

# Match logs from cproduct-service container
[FILTER]
    Name   grep
    Match  kube.*
    Regex  container_name  cproduct-service

[FILTER]
    Name   record_modifier
    Match  kube.*
    Record service.name product-api

# Match logs from cfrontend-app container
[FILTER]
    Name   grep
    Match  kube.*
    Regex  container_name  cfrontend-app

[FILTER]
    Name   record_modifier
    Match  kube.*
    Record service.name frontend-app


# Forward logs to New Relic
[OUTPUT]
    Name          http
    Match         *
    Host          log-api.newrelic.com
    Port          443
    URI           /log/v1
    Format        json
    TLS           On
    Header        X-License-Key ${NEW_RELIC_LICENSE_KEY}
    Compress      gzip




# [SERVICE]
#     Flush         1
#     Log_Level     info
#     Parsers_File  /fluent-bit/etc/parsers.conf

# # Tail all Docker container logs
# [INPUT]
#     Name   tail
#     Path   /var/lib/docker/containers/*/*.log
#     Parser docker
#     Tag    user-api.*

# [INPUT]
#     Name   tail
#     Path   /var/lib/docker/containers/*/*.log
#     Parser docker
#     Tag    product-api.*

# [INPUT]
#     Name   tail
#     Path   /var/lib/docker/containers/*/*.log
#     Parser docker
#     Tag    order-api.*

# [INPUT]
#     Name   tail
#     Path   /var/lib/docker/containers/*/*.log
#     Parser docker
#     Tag    frontend.*

# # Add service.name to each log
# [FILTER]
#     Name   record_modifier
#     Match  user-api.*
#     Record service.name user-api

# [FILTER]
#     Name   record_modifier
#     Match  product-api.*
#     Record service.name product-api

# [FILTER]
#     Name   record_modifier
#     Match  order-api.*
#     Record service.name order-api

# [FILTER]
#     Name   record_modifier
#     Match  frontend.*
#     Record service.name frontend

# # Forward logs to New Relic
# [OUTPUT]
#     Name          http
#     Match         *
#     Host          log-api.newrelic.com
#     Port          443
#     URI           /log/v1
#     Format        json
#     TLS           On
#     Header        X-License-Key ${NEW_RELIC_LICENSE_KEY}
#     Compress      gzip





# [SERVICE]
#     Flush         1
#     Log_Level     info
#     Parsers_File  /fluent-bit/etc/parsers.conf

# # Tail all Docker container logs
# [INPUT]
#     Name   tail
#     Path   /var/lib/docker/containers/*/*.log
#     Parser docker
#     Tag    container.*

# # Map container_name to service.name
# [FILTER]
#     Name   record_modifier
#     Match  container.*
#     # Add rules for each container
#     Record service.name user-api
#     Condition Key container_name Value cuser-service

# [FILTER]
#     Name   record_modifier
#     Match  container.*
#     Record service.name product-api
#     Condition Key container_name Value cproduct-service

# [FILTER]
#     Name   record_modifier
#     Match  container.*
#     Record service.name order-api
#     Condition Key container_name Value corder-service

# [FILTER]
#     Name   record_modifier
#     Match  container.*
#     Record service.name frontend
#     Condition Key container_name Value cfrontend-app

# # Forward logs to New Relic
# [OUTPUT]
#     Name          http
#     Match         *
#     Host          log-api.newrelic.com
#     Port          443
#     URI           /log/v1
#     Format        json
#     TLS           On
#     Header        X-License-Key 5b3c738c91170cdd1febd7d1865a243bFFFFNRAL
#     Compress      gzip



# [SERVICE]
#     Flush         1
#     Log_Level     info

# # Input: collect all Docker container logs
# [INPUT]
#     Name          tail
#     Path          /var/lib/docker/containers/*/*.log
#     Parser        docker
#     Tag           docker.*

# # Kubernetes / Docker metadata filter
# [FILTER]
#     Name          kubernetes
#     Match         docker.*
#     Merge_Log     On
#     K8S-Logging.Parser On
#     K8S-Logging.Exclude On

# # Enrich logs with OTEL service name
# [FILTER]
#     Name          record_modifier
#     Match         *
#     Record        service.name ${OTEL_SERVICE_NAME}

# # Output to New Relic Logs API
# [OUTPUT]
#     Name          http
#     Match         *
#     Host          log-api.newrelic.com
#     Port          443
#     URI           /log/v1
#     Format        json
#     TLS           On
#     Header        X-License-Key 5b3c738c91170cdd1febd7d1865a243bFFFFNRAL
#     Compress      gzip
